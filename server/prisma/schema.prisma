generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                         Int                     @id @default(autoincrement())
  nombre                     String
  email                      String                  @unique
  password                   String
  rol                        Role                    @default(cajero)
  sucursal                   String
  turno                      Turno                   @default(MATUTINO)
  activo                     Boolean                 @default(true)
  createdAt                  DateTime                @default(now()) @map("created_at")
  updatedAt                  DateTime                @updatedAt @map("updated_at")
  quickAccessToken           String?                 @unique @map("quick_access_token")
  importacionesMasivas       BulkImport[]            @relation("ImportacionesMasivas")
  cajasAbiertas              Caja[]                  @relation("UsuarioApertura")
  cajasCerradas              Caja[]                  @relation("UsuarioCierre")
  auditoriaCarrito           CarritoAuditoria[]      @relation("AuditoriaCarrito")
  ventasEnEspera             PendingSale[]           @relation("VentasEnEspera")
  cambiosProductos           ProductChange[]         @relation("CambiosProductos")
  productosCreados           Product[]               @relation("ProductosCreados")
  movimientosStock           StockMovement[]         @relation("MovimientosStock")
  transaccionesCreadas       Transaccion[]           @relation("VentasCreadas")
  transaccionesEliminadas    Transaccion[]           @relation("TransaccionesEliminadas")
  documentosCreados          VentaDocumento[]        @relation("DocumentosCreados")
  serviciosCreados           ServicioTecnico[]       @relation("ServiciosCreados")
  serviciosAsignados         ServicioTecnico[]       @relation("ServiciosTecnico")
  serviciosEliminados        ServicioTecnico[]       @relation("ServiciosEliminados")
  pagosServicioRegistrados   ServicioTecnicoPago[]   @relation("PagosServicioRegistrados")
  tecnicoConfig              TecnicoConfig?          @relation("ConfigTecnico")
  solicitudesDescuento       DiscountRequest[]       @relation("SolicitudesDescuento")
  aprobacionesDescuento      DiscountRequest[]       @relation("AprobacionesDescuento")
  rechazosDescuento          DiscountRequest[]       @relation("RechazosDescuento")
  presupuestosCreados        Presupuesto[]          @relation("PresupuestosCreados")

  @@map("users")
}

model Caja {
  id                    Int           @id @default(autoincrement())
  horaApertura          String?       @map("hora_apertura")
  montoInicialBs        Decimal       @default(0) @map("monto_inicial_bs") @db.Decimal(12, 2)
  montoInicialUsd       Decimal       @default(0) @map("monto_inicial_usd") @db.Decimal(12, 2)
  estado                EstadoCaja    @default(ABIERTA)
  usuarioAperturaId     Int           @map("usuario_apertura_id")
  usuarioCierreId       Int?          @map("usuario_cierre_id")
  horaCierre            String?       @map("hora_cierre")
  createdAt             DateTime      @default(now()) @map("created_at")
  updatedAt             DateTime      @updatedAt @map("updated_at")
  fecha                 DateTime      @db.Date
  totalEgresosBs        Decimal       @default(0) @map("total_egresos_bs") @db.Decimal(12, 2)
  totalEgresosUsd       Decimal       @default(0) @map("total_egresos_usd") @db.Decimal(12, 2)
  totalIngresosBs       Decimal       @default(0) @map("total_ingresos_bs") @db.Decimal(12, 2)
  totalIngresosUsd      Decimal       @default(0) @map("total_ingresos_usd") @db.Decimal(12, 2)
  montoInicialPagoMovil Decimal       @default(0) @map("monto_inicial_pago_movil") @db.Decimal(12, 2)
  totalPagoMovil        Decimal       @default(0) @map("total_pago_movil") @db.Decimal(12, 2)
  imagenApertura        String?       @map("imagen_apertura")
  imagenCierre          String?       @map("imagen_cierre")
  montoFinalBs          Decimal?      @map("monto_final_bs") @db.Decimal(12, 2)
  montoFinalPagoMovil   Decimal?      @map("monto_final_pago_movil") @db.Decimal(12, 2)
  montoFinalUsd         Decimal?      @map("monto_final_usd") @db.Decimal(12, 2)
  observacionesApertura String?       @map("observaciones_apertura")
  observacionesCierre   String?       @map("observaciones_cierre")
  tasaBcv               Decimal?      @map("tasa_bcv") @db.Decimal(8, 4)
  tasaParalelo          Decimal?      @map("tasa_paralelo") @db.Decimal(8, 4)
  fechaAutoCierre       DateTime?
  motivoAutoCierre      String?
  requiereConteoFisico  Boolean       @default(false)
  usuarioResponsableId  Int?
  arqueos               Arqueo[]
  usuarioApertura       User              @relation("UsuarioApertura", fields: [usuarioAperturaId], references: [id])
  usuarioCierre         User?             @relation("UsuarioCierre", fields: [usuarioCierreId], references: [id])
  ventasEnEspera        PendingSale[]     @relation("VentasEnEspera")
  transacciones         Transaccion[]
  serviciosIngreso      ServicioTecnico[] @relation("ServiciosIngreso")
  serviciosEntrega      ServicioTecnico[] @relation("ServiciosEntrega")

  @@map("cajas")
}

model Arqueo {
  id            Int              @id @default(autoincrement())
  cajaId        Int              @map("caja_id")
  metodoPago    MetodoPagoArqueo @map("metodo_pago")
  montoSistema  Decimal          @default(0) @map("monto_sistema") @db.Decimal(12, 2)
  montoContado  Decimal          @default(0) @map("monto_contado") @db.Decimal(12, 2)
  diferencia    Decimal          @default(0) @db.Decimal(12, 2)
  observaciones String?
  createdAt     DateTime         @default(now()) @map("created_at")
  updatedAt     DateTime         @updatedAt @map("updated_at")
  caja          Caja             @relation(fields: [cajaId], references: [id], onDelete: Cascade)

  @@map("arqueos")
}

model Transaccion {
  id                  Int                @id @default(autoincrement())
  cajaId              Int                @map("caja_id")
  tipo                TipoTransaccion
  categoria           String
  observaciones       String?
  totalBs             Decimal            @map("total_bs") @db.Decimal(12, 2)
  totalUsd            Decimal            @map("total_usd") @db.Decimal(12, 2)
  tasaCambioUsada     Decimal?           @map("tasa_cambio_usada") @db.Decimal(8, 4)
  fechaHora           DateTime           @default(now()) @map("fecha_hora")
  usuarioId           Int                @map("usuario_id")
  clienteId           Int?               @map("cliente_id")
  clienteNombre       String?            @map("cliente_nombre")
  codigoVenta         String             @unique @map("codigo_venta")
  consecutivoDelDia   Int                @map("consecutivo_del_dia")
  metodoPagoPrincipal String?            @map("metodo_pago_principal")
  descuentoTotal      Decimal            @default(0) @map("descuento_total") @db.Decimal(12, 2)
  cantidadItems       Int                @default(0) @map("cantidad_items")
  ipAddress           String?            @map("ip_address")
  userAgent           String?            @map("user_agent")
  sesionId            String?            @map("sesion_id")
  tiempoServicio      Int?               @map("tiempo_servicio")
  numeroComprobante   String?            @unique @map("numero_comprobante")
  requiereFactura     Boolean            @default(false) @map("requiere_factura")
  facturaGenerada     Boolean            @default(false) @map("factura_generada")
  reciboGenerado      Boolean            @default(false) @map("recibo_generado")

  // Soft Delete
  deletedAt           DateTime?          @map("deleted_at")
  motivoEliminacion   String?            @map("motivo_eliminacion")
  eliminadoPorId       Int?               @map("eliminado_por_id")

  auditoriaCarrito    CarritoAuditoria[]    @relation("AuditoriaVentas")
  pagos               Pago[]
  movimientosStock    StockMovement[]
  caja                Caja                  @relation(fields: [cajaId], references: [id])
  cliente             Cliente?              @relation("VentasCliente", fields: [clienteId], references: [id])
  usuario             User                  @relation("VentasCreadas", fields: [usuarioId], references: [id])
  eliminadoPor        User?                 @relation("TransaccionesEliminadas", fields: [eliminadoPorId], references: [id])
  items               TransactionItem[]
  documentos          VentaDocumento[]      @relation("DocumentosTransaccion")
  servicioTecnicoId   Int?                  @map("servicio_tecnico_id")
  pagosServicio       ServicioTecnicoPago[] @relation("PagosServicio")
  servicioTecnico     ServicioTecnico?      @relation("TransaccionesServicio", fields: [servicioTecnicoId], references: [id])

  @@map("transacciones")
}

model Pago {
  id            Int         @id @default(autoincrement())
  transaccionId Int         @map("transaccion_id")
  metodo        String
  monto         Decimal     @db.Decimal(12, 4)
  moneda        String
  banco         String?
  referencia    String?
  transaccion   Transaccion @relation(fields: [transaccionId], references: [id], onDelete: Cascade)

  @@map("pagos")
}

model Product {
  id                   Int                          @id @default(autoincrement())
  descripcion          String
  tipo                 TipoProducto                 @default(PRODUCTO)
  codigoBarras         String                       @map("codigo_barras")
  codigoInterno        String                       @map("codigo_interno")
  categoria            String?
  precioCosto          Decimal                      @map("precio_costo") @db.Decimal(12, 2)
  precioVenta          Decimal                      @map("precio_venta") @db.Decimal(12, 2)
  margenPorcentaje     Decimal?                     @map("margen_porcentaje") @db.Decimal(5, 2)
  stock                Int                          @default(0)
  stockDisponible      Int                          @default(0) @map("stock_disponible")
  stockMinimo          Int                          @default(5) @map("stock_minimo")
  stockMaximo          Int                          @default(100) @map("stock_maximo")
  ubicacionFisica      String?                      @map("ubicacion_fisica")
  imagenUrl            String?                      @map("imagen_url")
  imagenThumbnail      String?                      @map("imagen_thumbnail")
  proveedorFacturaIva  Boolean?                     @default(false) @map("proveedor_factura_iva")
  proveedor            String?
  telefonoProveedor    String?                      @map("telefono_proveedor")
  activo               Boolean                      @default(true)
  observaciones        String?
  creadoPorId          Int                          @map("creado_por_id")
  fechaCreacion        DateTime                     @default(now()) @map("fecha_creacion")
  fechaActualizacion   DateTime                     @updatedAt @map("fecha_actualizacion")
  ultimaVenta          DateTime?                    @map("ultima_venta")
  fechaInactivacion    DateTime?                    @map("fecha_inactivacion")
  motivoInactivacion   String?                      @map("motivo_inactivacion")
  proveedorId          Int?                         @map("proveedor_id")
  stockReservado       Int                          @default(0)
  auditoriasInventario AuditoriaInventarioDetalle[]
  importacionItems     BulkImportItem[]             @relation("ImportacionItems")
  auditoriaCarrito     CarritoAuditoria[]           @relation("AuditoriaProductos")
  itemsEnEspera        PendingSaleItem[]            @relation("ProductosEnEspera")
  cambiosProducto      ProductChange[]
  creadoPor            User                         @relation("ProductosCreados", fields: [creadoPorId], references: [id])
  proveedorRel         Proveedor?                   @relation("ProveedorProductos", fields: [proveedorId], references: [id])
  movimientosStock     StockMovement[]
  itemsTransaccion     TransactionItem[]
  itemsServicioTecnico ServicioTecnicoItem[]        @relation("ItemsServicioTecnico")

  @@map("products")
}

model StockMovement {
  id            Int            @id @default(autoincrement())
  productoId    Int            @map("producto_id")
  tipo          TipoMovimiento
  cantidad      Int
  stockAnterior Int            @map("stock_anterior")
  stockNuevo    Int            @map("stock_nuevo")
  precio        Decimal?       @db.Decimal(12, 2)
  transaccionId Int?           @map("transaccion_id")
  ventaEsperaId Int?           @map("venta_espera_id")
  importacionId Int?           @map("importacion_id")
  motivo        String?
  observaciones String?
  usuarioId     Int            @map("usuario_id")
  fecha         DateTime       @default(now())
  ipAddress     String?        @map("ip_address")
  importacion   BulkImport?    @relation(fields: [importacionId], references: [id])
  producto      Product        @relation(fields: [productoId], references: [id])
  transaccion   Transaccion?   @relation(fields: [transaccionId], references: [id])
  usuario       User           @relation("MovimientosStock", fields: [usuarioId], references: [id])
  ventaEspera   PendingSale?   @relation(fields: [ventaEsperaId], references: [id])

  @@map("stock_movements")
}

model ProductChange {
  id            Int      @id @default(autoincrement())
  productoId    Int      @map("producto_id")
  campo         String
  valorAnterior String?  @map("valor_anterior")
  valorNuevo    String?  @map("valor_nuevo")
  usuarioId     Int      @map("usuario_id")
  fecha         DateTime @default(now())
  ipAddress     String?  @map("ip_address")
  userAgent     String?  @map("user_agent")
  motivo        String?
  producto      Product  @relation(fields: [productoId], references: [id])
  usuario       User     @relation("CambiosProductos", fields: [usuarioId], references: [id])

  @@map("product_changes")
}

model TransactionItem {
  id             Int         @id @default(autoincrement())
  transaccionId  Int         @map("transaccion_id")
  productoId     Int?        @map("producto_id")
  descripcion    String
  codigoBarras   String      @map("codigo_barras")
  cantidad       Int
  precioUnitario Decimal     @map("precio_unitario") @db.Decimal(12, 2)
  precioCosto    Decimal     @map("precio_costo") @db.Decimal(12, 2)
  descuento      Decimal     @default(0) @db.Decimal(12, 2)
  subtotal       Decimal     @db.Decimal(12, 2)
  producto       Product?    @relation(fields: [productoId], references: [id])
  transaccion    Transaccion @relation(fields: [transaccionId], references: [id], onDelete: Cascade)

  @@map("transaction_items")
}

model PendingSale {
  id                Int                @id @default(autoincrement())
  numeroVenta       String             @unique @map("numero_venta")
  usuarioId         Int                @map("usuario_id")
  cajaId            Int                @map("caja_id")
  clienteId         Int?               @map("cliente_id")
  clienteNombre     String?            @map("cliente_nombre")
  subtotal          Decimal            @db.Decimal(12, 2)
  descuento         Decimal            @default(0) @db.Decimal(12, 2)
  total             Decimal            @db.Decimal(12, 2)
  tasaCambio        Decimal            @map("tasa_cambio") @db.Decimal(8, 4)
  tipoEspera        TipoVentaEspera    @default(INTENCIONAL) @map("tipo_espera")
  esIntencional     Boolean            @default(true) @map("es_intencional")
  fechaCreacion     DateTime           @default(now()) @map("fecha_creacion")
  fechaExpiracion   DateTime           @map("fecha_expiracion")
  tiempoLimiteMin   Int                @default(120) @map("tiempo_limite_min")
  ultimaActividad   DateTime           @default(now()) @map("ultima_actividad")
  sesionActiva      Boolean            @default(true) @map("sesion_activa")
  estado            EstadoVentaEspera  @default(ACTIVA)
  observaciones     String?
  motivoCancelacion String?            @map("motivo_cancelacion")
  auditoriaCarrito  CarritoAuditoria[] @relation("AuditoriaEspera")
  items             PendingSaleItem[]
  caja              Caja               @relation("VentasEnEspera", fields: [cajaId], references: [id])
  usuario           User               @relation("VentasEnEspera", fields: [usuarioId], references: [id])
  movimientosStock  StockMovement[]

  @@map("pending_sales")
}

model PendingSaleItem {
  id             Int         @id @default(autoincrement())
  ventaEsperaId  Int         @map("venta_espera_id")
  productoId     Int         @map("producto_id")
  descripcion    String
  codigoBarras   String      @map("codigo_barras")
  cantidad       Int
  precioUnitario Decimal     @map("precio_unitario") @db.Decimal(12, 2)
  descuento      Decimal     @default(0) @db.Decimal(12, 2)
  subtotal       Decimal     @db.Decimal(12, 2)
  producto       Product     @relation("ProductosEnEspera", fields: [productoId], references: [id])
  ventaEspera    PendingSale @relation(fields: [ventaEsperaId], references: [id], onDelete: Cascade)

  @@map("pending_sale_items")
}

model BulkImport {
  id                    Int               @id @default(autoincrement())
  numeroFactura         String            @map("numero_factura")
  proveedor             String
  telefono              String?
  fechaCompra           DateTime          @map("fecha_compra")
  totalProductos        Int               @map("total_productos")
  productosCreados      Int               @map("productos_creados")
  productosActualizados Int               @map("productos_actualizados")
  montoTotal            Decimal           @map("monto_total") @db.Decimal(12, 2)
  usuarioId             Int               @map("usuario_id")
  fechaImportacion      DateTime          @default(now()) @map("fecha_importacion")
  archivoOriginal       String?           @map("archivo_original")
  observaciones         String?
  estado                EstadoImportacion @default(COMPLETADA)
  items                 BulkImportItem[]
  usuario               User              @relation("ImportacionesMasivas", fields: [usuarioId], references: [id])
  movimientosStock      StockMovement[]

  @@map("bulk_imports")
}

model BulkImportItem {
  id            Int               @id @default(autoincrement())
  importacionId Int               @map("importacion_id")
  productoId    Int?              @map("producto_id")
  descripcion   String
  codigoBarras  String            @map("codigo_barras")
  cantidad      Int
  precioCosto   Decimal           @map("precio_costo") @db.Decimal(12, 2)
  precioVenta   Decimal           @map("precio_venta") @db.Decimal(12, 2)
  accion        AccionImportacion
  mensajeError  String?           @map("mensaje_error")
  importacion   BulkImport        @relation(fields: [importacionId], references: [id], onDelete: Cascade)
  producto      Product?          @relation("ImportacionItems", fields: [productoId], references: [id])

  @@map("bulk_import_items")
}

model Cliente {
  id        Int               @id @default(autoincrement())
  cedula_rif String           @unique
  nombre    String
  telefono  String?
  email     String?
  direccion String?
  tipo      String
  activo    Boolean           @default(true)
  createdAt DateTime          @default(now()) @map("created_at")
  updatedAt DateTime          @updatedAt @map("updated_at")
  ventas    Transaccion[]     @relation("VentasCliente")
  servicios ServicioTecnico[] @relation("ServiciosCliente")
  presupuestos Presupuesto[]  @relation("PresupuestosCliente")

  @@map("clientes")
}

model Proveedor {
  id        Int       @id @default(autoincrement())
  nombre    String
  contacto  String?
  telefono  String?
  email     String?
  direccion String?
  rif       String?   @unique
  activo    Boolean   @default(true)
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  productos Product[] @relation("ProveedorProductos")

  @@map("proveedores")
}

model CarritoAuditoria {
  id                Int           @id @default(autoincrement())
  sesionId          String        @map("sesion_id")
  usuarioId         Int           @map("usuario_id")
  productoId        Int           @map("producto_id")
  accion            AccionCarrito
  cantidadAnterior  Int?          @map("cantidad_anterior")
  cantidadNueva     Int           @map("cantidad_nueva")
  precioUnitario    Decimal       @map("precio_unitario") @db.Decimal(12, 2)
  motivoEliminacion String?       @map("motivo_eliminacion")
  fechaHora         DateTime      @default(now()) @map("fecha_hora")
  ipAddress         String?       @map("ip_address")
  userAgent         String?       @map("user_agent")
  tiempoEnCarrito   Int?          @map("tiempo_en_carrito")
  fueComprado       Boolean?      @map("fue_comprado")
  transaccionId     Int?          @map("transaccion_id")
  ventaEsperaId     Int?          @map("venta_espera_id")
  producto          Product       @relation("AuditoriaProductos", fields: [productoId], references: [id])
  transaccion       Transaccion?  @relation("AuditoriaVentas", fields: [transaccionId], references: [id])
  usuario           User          @relation("AuditoriaCarrito", fields: [usuarioId], references: [id])
  ventaEspera       PendingSale?  @relation("AuditoriaEspera", fields: [ventaEsperaId], references: [id])

  @@map("carrito_auditoria")
}

model VentaDocumento {
  id                Int              @id @default(autoincrement())
  transaccionId     Int              @map("transaccion_id")
  tipoDocumento     TipoDocumento    @map("tipo_documento")
  numeroComprobante String           @map("numero_comprobante")
  archivoUrl        String           @map("archivo_url")
  nombreArchivo     String           @map("nombre_archivo")
  tamaño           Int?             @map("tamaño")
  hash              String?
  estado            EstadoDocumento  @default(GENERADO)
  formatoImpresion  FormatoImpresion @map("formato_impresion")
  impreso           Boolean          @default(false)
  fechaImpresion    DateTime?        @map("fecha_impresion")
  reimpresiones     Int              @default(0)
  fechaCreacion     DateTime         @default(now()) @map("fecha_creacion")
  usuarioCreacion   Int              @map("usuario_creacion")
  observaciones     String?
  esFiscal          Boolean          @default(false) @map("es_fiscal")
  numeroFiscal      String?          @map("numero_fiscal")
  tipoContribuyente String?          @map("tipo_contribuyente")
  transaccion       Transaccion      @relation("DocumentosTransaccion", fields: [transaccionId], references: [id])
  usuario           User             @relation("DocumentosCreados", fields: [usuarioCreacion], references: [id])

  @@unique([numeroComprobante, tipoDocumento])
  @@map("venta_documentos")
}

model AuditoriaInventario {
  id                     Int                          @id @default(autoincrement())
  auditor                String
  observaciones          String?
  fechaAuditoria         DateTime                     @default(now()) @map("fecha_auditoria")
  estado                 EstadoAuditoria              @default(EN_PROGRESO)
  totalProductos         Int                          @map("total_productos")
  totalDiferencias       Int                          @default(0) @map("total_diferencias")
  valorTotalDiferencias  Decimal                      @default(0) @map("valor_total_diferencias") @db.Decimal(12, 2)
  ajustesAplicados       Boolean                      @default(false) @map("ajustes_aplicados")
  fechaAplicacionAjustes DateTime?                    @map("fecha_aplicacion_ajustes")
  createdAt              DateTime                     @default(now()) @map("created_at")
  updatedAt              DateTime                     @updatedAt @map("updated_at")
  detalles               AuditoriaInventarioDetalle[]

  @@map("auditorias_inventario")
}

model AuditoriaInventarioDetalle {
  id              Int                 @id @default(autoincrement())
  auditoriaId     Int                 @map("auditoria_id")
  productoId      Int                 @map("producto_id")
  stockSistema    Int                 @map("stock_sistema")
  stockFisico     Int                 @map("stock_fisico")
  diferencia      Int
  valorDiferencia Decimal             @map("valor_diferencia") @db.Decimal(12, 2)
  observaciones   String?
  createdAt       DateTime            @default(now()) @map("created_at")
  auditoria       AuditoriaInventario @relation(fields: [auditoriaId], references: [id], onDelete: Cascade)
  producto        Product             @relation(fields: [productoId], references: [id])

  @@map("auditoria_inventario_detalles")
}

// ============================================
// SERVICIOS TÉCNICOS
// ============================================

model ServicioTecnico {
  id                    Int                      @id @default(autoincrement())
  numeroServicio        String                   @unique @map("numero_servicio")
  consecutivoDelDia     Int                      @map("consecutivo_del_dia")

  // Cliente
  clienteId             Int?                     @map("cliente_id")
  clienteNombre         String                   @map("cliente_nombre")
  clienteTelefono       String                   @map("cliente_telefono")
  clienteEmail          String?                  @map("cliente_email")
  clienteDireccion      String?                  @map("cliente_direccion")
  clienteCedulaRif      String                   @map("cliente_cedula_rif")

  // Dispositivo
  dispositivoMarca      String                   @map("dispositivo_marca")
  dispositivoModelo     String                   @map("dispositivo_modelo")
  dispositivoColor      String?                  @map("dispositivo_color")
  dispositivoImei       String                   @map("dispositivo_imei")
  accesorios            Json?                    // Array de strings
  problemas             Json                     // Array de strings (requerido)
  evidencias            Json?                    // Array de {id, url, name, type, size}

  // Diagnóstico
  estado                EstadoServicio           @default(RECIBIDO)
  tecnicoAsignado       String                   @map("tecnico_asignado")
  tecnicoId             Int?                     @map("tecnico_id") // FK a User
  observaciones         String?

  // Fechas
  fechaIngreso          DateTime                 @default(now()) @map("fecha_ingreso")
  fechaEntregaEstimada  DateTime                 @map("fecha_entrega_estimada")
  fechaEntregaReal      DateTime?                @map("fecha_entrega_real")

  // Financiero
  modalidadPago         ModalidadPagoServicio    @map("modalidad_pago")
  totalEstimado         Decimal                  @map("total_estimado") @db.Decimal(12, 2)
  totalReal             Decimal?                 @map("total_real") @db.Decimal(12, 2)
  totalPagado           Decimal                  @default(0) @map("total_pagado") @db.Decimal(12, 2)
  saldoPendiente        Decimal                  @default(0) @map("saldo_pendiente") @db.Decimal(12, 2)

  // Auditoría
  creadoPorId           Int                      @map("creado_por_id")
  cajaIngresoId         Int?                     @map("caja_ingreso_id")
  cajaEntregaId         Int?                     @map("caja_entrega_id")

  // Notificaciones
  whatsappEnviado       Boolean                  @default(false) @map("whatsapp_enviado")
  whatsappFechaEnvio    DateTime?                @map("whatsapp_fecha_envio")

  // Reimpresiones
  reimpresiones         Int                      @default(0) @map("reimpresiones")

  // Seguimiento público
  tokenUnico            String?                  @unique @map("token_unico") // Token único para acceso público
  linkSeguimiento       String?                  @map("link_seguimiento") // URL completa de seguimiento

  // Soft Delete
  deletedAt             DateTime?                @map("deleted_at")
  motivoEliminacion     String?                  @map("motivo_eliminacion")
  eliminadoPorId        Int?                     @map("eliminado_por_id")

  createdAt             DateTime                 @default(now()) @map("created_at")
  updatedAt             DateTime                 @updatedAt @map("updated_at")

  // Relaciones
  cliente               Cliente?                 @relation("ServiciosCliente", fields: [clienteId], references: [id])
  tecnico               User?                    @relation("ServiciosTecnico", fields: [tecnicoId], references: [id])
  creadoPor             User                     @relation("ServiciosCreados", fields: [creadoPorId], references: [id])
  eliminadoPor          User?                    @relation("ServiciosEliminados", fields: [eliminadoPorId], references: [id])
  cajaIngreso           Caja?                    @relation("ServiciosIngreso", fields: [cajaIngresoId], references: [id])
  cajaEntrega           Caja?                    @relation("ServiciosEntrega", fields: [cajaEntregaId], references: [id])

  items                 ServicioTecnicoItem[]
  pagos                 ServicioTecnicoPago[]
  notas                 ServicioTecnicoNota[]
  transacciones         Transaccion[]           @relation("TransaccionesServicio")

  @@index([estado])
  @@index([tecnicoId])
  @@index([clienteId])
  @@index([fechaIngreso])
  @@index([tokenUnico])
  @@index([deletedAt]) // Optimizar filtro de soft-delete
  @@index([estado, fechaIngreso]) // Índice compuesto para consultas comunes
  @@index([estado, deletedAt]) // Optimizar filtros combinados
  @@map("servicios_tecnicos")
}

model ServicioTecnicoItem {
  id              Int              @id @default(autoincrement())
  servicioId      Int              @map("servicio_id")
  productoId      Int?             @map("producto_id")
  descripcion     String
  cantidad        Int
  precioUnitario  Decimal          @map("precio_unitario") @db.Decimal(12, 2)
  subtotal        Decimal          @db.Decimal(12, 2)
  esPersonalizado Boolean          @default(false) @map("es_personalizado")

  servicio        ServicioTecnico  @relation(fields: [servicioId], references: [id], onDelete: Cascade)
  producto        Product?         @relation("ItemsServicioTecnico", fields: [productoId], references: [id])

  @@map("servicio_tecnico_items")
}

model ServicioTecnicoPago {
  id             Int              @id @default(autoincrement())
  servicioId     Int              @map("servicio_id")
  transaccionId  Int?             @map("transaccion_id")

  tipo           TipoPagoServicio
  monto          Decimal          @db.Decimal(12, 2)
  pagos          Json             // Array de {metodo, monto, moneda, banco, referencia}
  vueltos        Json?            // Array de vueltos
  tasaCambioUsada Decimal?       @map("tasa_cambio_usada") @db.Decimal(8, 4) // ✅ Tasa de cambio al momento del pago

  fecha          DateTime         @default(now())
  usuarioId      Int              @map("usuario_id")

  servicio       ServicioTecnico  @relation(fields: [servicioId], references: [id], onDelete: Cascade)
  transaccion    Transaccion?     @relation("PagosServicio", fields: [transaccionId], references: [id])
  usuario        User             @relation("PagosServicioRegistrados", fields: [usuarioId], references: [id])

  @@map("servicio_tecnico_pagos")
}

model ServicioTecnicoNota {
  id              Int              @id @default(autoincrement())
  servicioId      Int              @map("servicio_id")

  tipo            TipoNotaServicio
  contenido       String?          @db.Text
  archivoUrl      String?          @map("archivo_url")
  grupoId         String?          @map("grupo_id") // ID para agrupar notas relacionadas (texto + imágenes)

  tecnico         String
  fecha           DateTime         @default(now())

  estadoAnterior  String?          @map("estado_anterior")
  estadoNuevo     String?          @map("estado_nuevo")

  publica         Boolean          @default(false) // Si el cliente puede ver esta nota

  servicio        ServicioTecnico  @relation(fields: [servicioId], references: [id], onDelete: Cascade)

  @@map("servicio_tecnico_notas")
}

// ============================================
// SUGERENCIAS INTELIGENTES PARA SERVICIOS
// ============================================
model SugerenciaServicio {
  id              Int      @id @default(autoincrement())
  tipo            String   // 'marca', 'modelo', 'problema'
  tipoDispositivo String?  @map("tipo_dispositivo") // 'telefono', 'laptop', etc. (null para problemas)
  valor           String   // El valor de la marca, modelo o problema
  marcaPadre      String?  @map("marca_padre") // Para modelos, la marca a la que pertenece
  frecuencia      Int      @default(1) // Contador de uso
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@unique([tipo, tipoDispositivo, valor, marcaPadre])
  @@index([tipo, tipoDispositivo])
  @@index([tipo, marcaPadre])
  @@map("sugerencias_servicio")
}

model DiscountRequest {
  id                Int                @id @default(autoincrement())
  sesionId          String             @unique @map("sesion_id") // ID único de la sesión de venta
  usuarioId         Int                @map("usuario_id")
  estado            DiscountRequestStatus @default(PENDIENTE)
  
  // Información de la venta
  ventaData         Json               @map("venta_data") // Datos completos de la venta
  items             Json               // Array de items de la venta
  cliente           Json?              // Información del cliente
  
  // Información del descuento
  tipoDescuento     String             @map("tipo_descuento") // 'porcentaje' | 'monto'
  montoDescuento    Decimal            @map("monto_descuento") @db.Decimal(12, 2)
  monedaDescuento   String             @map("moneda_descuento") // 'bs' | 'usd'
  porcentajeDescuento Decimal?         @map("porcentaje_descuento") @db.Decimal(5, 2)
  motivo            String             @db.Text
  
  // Totales
  totalVenta        Decimal            @map("total_venta") @db.Decimal(12, 2)
  totalConDescuento Decimal            @map("total_con_descuento") @db.Decimal(12, 2)
  tasaCambio        Decimal            @map("tasa_cambio") @db.Decimal(8, 4)
  
  // Aprobación
  aprobadoPorId     Int?               @map("aprobado_por_id")
  rechazadoPorId    Int?               @map("rechazado_por_id")
  motivoRechazo     String?            @map("motivo_rechazo") @db.Text
  
  createdAt         DateTime           @default(now()) @map("created_at")
  updatedAt         DateTime           @updatedAt @map("updated_at")
  aprobadoAt        DateTime?          @map("aprobado_at")
  rechazadoAt       DateTime?          @map("rechazado_at")
  
  // Relaciones
  usuario           User               @relation("SolicitudesDescuento", fields: [usuarioId], references: [id])
  aprobadoPor       User?              @relation("AprobacionesDescuento", fields: [aprobadoPorId], references: [id])
  rechazadoPor      User?              @relation("RechazosDescuento", fields: [rechazadoPorId], references: [id])
  
  @@index([estado])
  @@index([usuarioId])
  @@index([createdAt])
  @@map("discount_requests")
}

enum DiscountRequestStatus {
  PENDIENTE
  APROBADO
  RECHAZADO
  CANCELADO
}

model TecnicoConfig {
  id              Int              @id @default(autoincrement())
  usuarioId       Int              @unique @map("usuario_id")
  telefono        String?          // Para WhatsApp
  especialidad    String?
  activo          Boolean          @default(true)
  favorito        Boolean          @default(false) // Técnico favorito/default para asignación automática

  usuario         User             @relation("ConfigTecnico", fields: [usuarioId], references: [id])

  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")

  @@map("tecnicos_config")
}

enum Role {
  admin
  supervisor
  cajero
  viewer
}

enum Turno {
  MATUTINO
  VESPERTINO
  NOCTURNO
}

enum EstadoCaja {
  ABIERTA
  CERRADA
  PENDIENTE_CIERRE_FISICO
}

enum TipoTransaccion {
  INGRESO
  EGRESO
}

enum MetodoPagoArqueo {
  EFECTIVO_BS
  EFECTIVO_USD
  PAGO_MOVIL
}

enum TipoProducto {
  PRODUCTO
  SERVICIO
  ELECTROBAR
}

enum TipoMovimiento {
  ENTRADA
  SALIDA
  RESERVA
  LIBERACION
  AJUSTE_POSITIVO
  AJUSTE_NEGATIVO
  TRANSFERENCIA
  MERMA
}

enum EstadoVentaEspera {
  ACTIVA
  CONFIRMADA
  CANCELADA
  EXPIRADA
}

enum TipoVentaEspera {
  INTENCIONAL
  EMERGENCIA
  DESCONEXION
}

enum AccionImportacion {
  CREAR
  ACTUALIZAR
  ERROR
}

enum EstadoImportacion {
  PROCESANDO
  COMPLETADA
  ERROR
  CANCELADA
}

enum AccionCarrito {
  AGREGAR
  MODIFICAR
  ELIMINAR
  PROCESAR
  CANCELAR
  GUARDAR_ESPERA
  RETOMAR_ESPERA
}

enum TipoDocumento {
  RECIBO_VENTA
  FACTURA_NO_FISCAL
  NOTA_ENTREGA
  COMPROBANTE_PAGO
  COTIZACION
}

enum EstadoServicio {
  RECIBIDO
  EN_DIAGNOSTICO
  ESPERANDO_APROBACION
  EN_REPARACION
  LISTO_RETIRO
  ENTREGADO
  CANCELADO
}

enum ModalidadPagoServicio {
  TOTAL_ADELANTADO
  ABONO
  PAGO_POSTERIOR
}

enum TipoPagoServicio {
  PAGO_INICIAL
  PAGO_ABONO
  PAGO_FINAL
}

enum TipoNotaServicio {
  TEXTO
  IMAGEN
  AUDIO
  CAMBIO_ESTADO
  MODIFICACION_ITEMS
  ELIMINACION
}

enum EstadoDocumento {
  GENERADO
  ERROR_GENERACION
  ELIMINADO
  REEMPLAZADO
}

enum FormatoImpresion {
  TERMICA_58MM
  TERMICA_80MM
  A4
  TICKET
  MEDIA_CARTA
}

enum EstadoAuditoria {
  EN_PROGRESO
  COMPLETADA
  CANCELADA
}

model Presupuesto {
  id                Int                  @id @default(autoincrement())
  numero            String               @unique
  fecha             DateTime             @db.Date
  fechaVencimiento  DateTime             @map("fecha_vencimiento") @db.Date
  validezDias       Int                  @default(1) @map("validez_dias")
  
  // Cliente
  clienteId         Int?                 @map("cliente_id")
  clienteNombre     String?              @map("cliente_nombre")
  clienteCedulaRif   String?              @map("cliente_cedula_rif")
  clienteTelefono    String?              @map("cliente_telefono")
  clienteEmail       String?              @map("cliente_email")
  
  // Items (JSON)
  items             Json                 // Array de items
  
  // Totales
  subtotal          Decimal              @db.Decimal(12, 2)
  descuentoGlobal   Decimal              @default(0) @map("descuento_global") @db.Decimal(12, 2)
  tipoDescuento     String               @default("porcentaje") @map("tipo_descuento")
  impuestos         Decimal              @default(16) @db.Decimal(5, 2)
  totalUsd          Decimal              @map("total_usd") @db.Decimal(12, 2)
  totalBs           Decimal              @map("total_bs") @db.Decimal(12, 2)
  tasaCambio        Decimal              @map("tasa_cambio") @db.Decimal(8, 4)
  
  // Observaciones
  observaciones     Json?                // Array de strings
  
  // Configuración de export
  exportConfig      Json?                @map("export_config") // {pdf, whatsapp, email, vistaPrevia}
  
  // Estado
  estado            EstadoPresupuesto    @default(BORRADOR)
  version           Int                  @default(1)
  
  // Auditoría
  creadoPorId       Int                  @map("creado_por_id")
  createdAt         DateTime             @default(now()) @map("created_at")
  updatedAt         DateTime             @updatedAt @map("updated_at")
  
  // Relaciones
  cliente           Cliente?              @relation("PresupuestosCliente", fields: [clienteId], references: [id])
  creadoPor         User                 @relation("PresupuestosCreados", fields: [creadoPorId], references: [id])
  
  @@index([clienteId])
  @@index([estado])
  @@index([fecha])
  @@index([numero])
  @@map("presupuestos")
}

enum EstadoPresupuesto {
  BORRADOR
  ENVIADO
  APROBADO
  RECHAZADO
  VENCIDO
  CONVERTIDO_VENTA
}