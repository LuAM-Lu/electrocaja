<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ Testing Backend - Electro Caja</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="app" class="container mx-auto p-6">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900 flex items-center">
                        <i class="fas fa-database text-blue-600 mr-3"></i>
                        Panel de Testing - Backend Electro Caja
                    </h1>
                    <p class="text-gray-600 mt-1">Prueba todas las funciones del backend</p>
                </div>
                <div class="text-right">
                    <div class="text-sm text-gray-500">Estado:</div>
                    <div class="text-lg font-semibold text-green-600" id="status">
                        Listo para testing
                    </div>
                </div>
            </div>
        </div>

        <!-- Controles -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <div class="flex flex-wrap gap-4 mb-4">
                <button onclick="ejecutarTodosLosTests()" id="btnEjecutarTodos" 
                        class="flex items-center px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    <i class="fas fa-play mr-2"></i>
                    Ejecutar Todos los Tests
                </button>
                
                <button onclick="limpiarResultados()" 
                        class="flex items-center px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                    <i class="fas fa-trash mr-2"></i>
                    Limpiar
                </button>
                
                <a href="https://localhost:5173" 
                   class="flex items-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                    <i class="fas fa-arrow-left mr-2"></i>
                    Volver al Sistema
                </a>
            </div>

            <!-- Tests individuales -->
            <div class="flex flex-wrap gap-2">
                <button onclick="testAuth()" class="btn-test">üîê Auth</button>
                <button onclick="testObtenerCaja()" class="btn-test">üìä Obtener Caja</button>
                <button onclick="testAbrirCaja()" class="btn-test">üè™ Abrir Caja</button>
                <button onclick="testCrearTransaccion()" class="btn-test">üí∞ Crear TX</button>
                <button onclick="testObtenerTransacciones()" class="btn-test">üìã Lista TX</button>
                <button onclick="testAutorizacionCEO()" class="btn-test">üîê CEO Auth</button>
                <button onclick="testArqueoSinDiferencias()" class="btn-test">üßÆ Arqueo OK</button>
                <button onclick="testArqueoConDiferencias()" class="btn-test">üö® Arqueo Diff</button>
                <button onclick="testEvidenciaFotografica()" class="btn-test">üì∏ Evidencia</button>
                <button onclick="testEliminarTransaccion()" class="btn-test">üóëÔ∏è Eliminar TX</button>
                <button onclick="testCerrarCaja()" class="btn-test">üîí Cerrar Caja</button>
                <button onclick="testObtenerHistorial()" class="btn-test">üìä Historial</button>
            </div>

            <!-- Estado actual -->
            <div id="currentTest" class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg hidden">
                <div class="flex items-center">
                    <i class="fas fa-spinner fa-spin text-blue-600 mr-2"></i>
                    <span class="text-blue-800 font-medium" id="currentTestText"></span>
                </div>
            </div>
        </div>

        <!-- Resultados -->
        <div class="bg-white rounded-lg shadow-sm">
            <div class="p-6 border-b border-gray-200">
                <h2 class="text-xl font-semibold text-gray-900">
                    Resultados de Tests (<span id="resultsCount">0</span>)
                </h2>
            </div>
            
            <div class="max-h-96 overflow-y-auto" id="resultsContainer">
                <div class="p-8 text-center text-gray-500" id="noResults">
                    <i class="fas fa-cogs text-6xl text-gray-300 mb-4"></i>
                    <p>No hay resultados a√∫n. Ejecuta algunos tests.</p>
                </div>
            </div>
        </div>
    </div>

    <style>
        .btn-test {
            @apply px-3 py-1.5 text-sm bg-gray-200 text-gray-700 rounded hover:bg-gray-300 transition-colors;
        }
        
        .result-success {
            @apply border-l-4 border-green-500 bg-green-50;
        }
        
        .result-error {
            @apply border-l-4 border-red-500 bg-red-50;
        }
    </style>

    <script>
        // Variables globales
        let authToken = localStorage.getItem('auth-token');
        let cajaId = null;
        let transaccionId = null;
        let results = [];
        let isRunning = false;

        // Configuraci√≥n de la API
        const API_BASE = 'https://localhost:3001/api';

        // Funci√≥n para hacer requests
        async function apiRequest(endpoint, options = {}) {
            const url = API_BASE + endpoint;
            const config = {
                headers: {
                    'Content-Type': 'application/json',
                    ...(authToken && { 'Authorization': `Bearer ${authToken}` })
                },
                ...options
            };

            const response = await fetch(url, config);
            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.message || `HTTP ${response.status}`);
            }

            return data;
        }

        // Agregar resultado
        function addResult(testName, success, data = null, error = null) {
            const result = {
                id: crypto.randomUUID(),
                test: testName,
                success,
                data: success ? data : null,
                error: error || null,
                timestamp: new Date().toLocaleTimeString()
            };

            results.unshift(result);
            updateResultsUI();

            if (success) {
                showToast(`‚úÖ ${testName}`, 'success');
            } else {
                showToast(`‚ùå ${testName}: ${error}`, 'error');
            }
        }

        // Actualizar UI de resultados
        // Actualizar UI de resultados
function updateResultsUI() {
    const container = document.getElementById('resultsContainer');
    const noResults = document.getElementById('noResults');
    const count = document.getElementById('resultsCount');

    // Verificar que los elementos existen
    if (!container || !count) {
        console.error('‚ùå Elementos no encontrados en el DOM');
        return;
    }

    count.textContent = results.length;

    if (results.length === 0) {
        if (noResults) {
            noResults.style.display = 'block';
        }
        return;
    }

    if (noResults) {
        noResults.style.display = 'none';
    }
    
    container.innerHTML = results.map(result => `
        <div class="p-4 border-b border-gray-200 ${result.success ? 'result-success' : 'result-error'}">
            <div class="flex items-start justify-between">
                <div class="flex items-start space-x-3 flex-1">
                    <i class="fas ${result.success ? 'fa-check-circle text-green-500' : 'fa-times-circle text-red-500'} mt-1"></i>
                    <div class="flex-1">
                        <div class="flex items-center space-x-2 mb-1">
                            <span class="font-medium text-gray-900">${result.test}</span>
                            <span class="text-xs text-gray-500">${result.timestamp}</span>
                        </div>
                        
                        ${result.success && result.data ? `
                            <div class="text-sm text-gray-600 bg-green-50 p-2 rounded mt-2">
                                <pre class="whitespace-pre-wrap text-xs">${JSON.stringify(result.data, null, 2)}</pre>
                            </div>
                        ` : ''}
                        
                        ${!result.success && result.error ? `
                            <div class="text-sm text-red-600 bg-red-50 p-2 rounded mt-2">
                                <pre class="whitespace-pre-wrap text-xs">${result.error}</pre>
                            </div>
                        ` : ''}
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

        // Mostrar estado actual
function setCurrentTest(text) {
    const currentTest = document.getElementById('currentTest');
    const currentTestText = document.getElementById('currentTestText');
    
    // Verificar que los elementos existen
    if (!currentTest || !currentTestText) {
        console.log('‚ö†Ô∏è Elementos currentTest no encontrados');
        return;
    }
    
    if (text) {
        currentTestText.textContent = text;
        currentTest.classList.remove('hidden');
    } else {
        currentTest.classList.add('hidden');
    }
}

        // Toast notifications
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
            
            toast.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-50 transform transition-transform`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Verificar token al cargar
        function checkAuth() {
            if (!authToken) {
                authToken = prompt('Ingresa tu token de autenticaci√≥n:');
                if (authToken) {
                    localStorage.setItem('auth-token', authToken);
                } else {
                    showToast('Token requerido para los tests', 'error');
                    return false;
                }
            }
            return true;
        }

        // TESTS INDIVIDUALES

        async function testAuth() {
            if (!checkAuth()) return;
            setCurrentTest('Verificando autenticaci√≥n...');
            try {
                const response = await apiRequest('/auth/me');
                addResult('AUTH - Verificar usuario', true, {
                    usuario: response.data.nombre,
                    rol: response.data.rol
                });
            } catch (error) {
                addResult('AUTH - Verificar usuario', false, null, error.message);
            }
            setCurrentTest('');
        }

        async function testAbrirCaja() {
            if (!checkAuth()) return;
            setCurrentTest('Abriendo caja...');
            try {
                const response = await apiRequest('/cajas/abrir', {
                    method: 'POST',
                    body: JSON.stringify({
                        montoInicialBs: 50000,
                        montoInicialUsd: 100,
                        montoInicialPagoMovil: 25000,
                        observacionesApertura: 'TEST: Apertura desde testing HTML'
                    })
                });
                
                cajaId = response.data.id;
                addResult('CAJA - Abrir caja', true, {
                    id: response.data.id,
                    montoInicialBs: response.data.montoInicialBs,
                    estado: response.data.estado
                });
            } catch (error) {
                addResult('CAJA - Abrir caja', false, null, error.message);
            }
            setCurrentTest('');
        }

        async function testObtenerCaja() {
            if (!checkAuth()) return;
            setCurrentTest('Obteniendo caja actual...');
            try {
                const response = await apiRequest('/cajas/actual');
                const caja = response.data.caja;
                
                if (caja) {
                    cajaId = caja.id;
                    addResult('CAJA - Obtener actual', true, {
                        id: caja.id,
                        estado: caja.estado,
                        transacciones: caja.transacciones?.length || 0
                    });
                } else {
                    addResult('CAJA - Obtener actual', true, { mensaje: 'No hay caja abierta' });
                }
            } catch (error) {
                addResult('CAJA - Obtener actual', false, null, error.message);
            }
            setCurrentTest('');
        }

        async function testCrearTransaccion() {
            if (!checkAuth()) return;
            setCurrentTest('Creando transacci√≥n...');
            try {
                const response = await apiRequest('/cajas/transacciones', {
                    method: 'POST',
                    body: JSON.stringify({
                        tipo: 'INGRESO',
                        categoria: 'TEST_VENTA_HTML',
                        observaciones: 'TEST: Transacci√≥n desde testing HTML',
                        totalBs: 15000,
                        totalUsd: 0,
                        tasaCambioUsada: 36.5,
                        pagos: [
                            {
                                metodo: 'efectivo_bs',
                                monto: 15000,
                                moneda: 'bs',
                                banco: null,
                                referencia: null
                            }
                        ]
                    })
                });
                
                transaccionId = response.data.id;
                addResult('TRANSACCI√ìN - Crear ingreso', true, {
                    id: response.data.id,
                    tipo: response.data.tipo,
                    totalBs: response.data.totalBs
                });
            } catch (error) {
                addResult('TRANSACCI√ìN - Crear ingreso', false, null, error.message);
            }
            setCurrentTest('');
        }

        async function testObtenerTransacciones() {
            if (!checkAuth()) return;
            setCurrentTest('Obteniendo transacciones...');
            try {
                const response = await apiRequest('/cajas/transacciones?page=1&limit=10&tipo=TODOS');
                addResult('TRANSACCI√ìN - Obtener lista', true, {
                    total: response.data.transacciones.length,
                    estadisticas: response.data.estadisticas
                });
            } catch (error) {
                addResult('TRANSACCI√ìN - Obtener lista', false, null, error.message);
            }
            setCurrentTest('');
        }

        async function testAutorizacionCEO() {
            if (!checkAuth()) return;
            setCurrentTest('Validando autorizaci√≥n CEO...');
            try {
                const response = await apiRequest('/cajas/autorizacion-ceo', {
                    method: 'POST',
                    body: JSON.stringify({
                        clave_ceo: '1234',
                        diferencias: { bs: 1000, usd: 0, pagoMovil: 0 },
                        accion: 'test_html',
                        caja_id: cajaId
                    })
                });
                
                addResult('CEO - Validar autorizaci√≥n', true, {
                    autorizado: response.data.autorizado,
                    ceo: response.data.ceo_info.nombre
                });
            } catch (error) {
                addResult('CEO - Validar autorizaci√≥n', false, null, error.message);
            }
            setCurrentTest('');
        }

        async function testArqueoSinDiferencias() {
            if (!checkAuth()) return;
            setCurrentTest('Realizando arqueo sin diferencias...');
            try {
                const response = await apiRequest('/cajas/arqueo', {
                    method: 'POST',
                    body: JSON.stringify({
                        conteos: {
                            efectivo_bs: 65000,
                            efectivo_usd: 100,
                            pago_movil: 25000
                        },
                        diferencias: {
                            bs: 0,
                            usd: 0,
                            pagoMovil: 0
                        },
                        observaciones: 'TEST: Arqueo sin diferencias desde HTML',
                        adminAutorizado: {
                            nombre: 'Administrador Test HTML',
                            rol: 'admin'
                        }
                    })
                });
                
                addResult('ARQUEO - Sin diferencias', true, {
                    arqueos: response.data.arqueos.length,
                    ajustesCreados: response.data.ajustesCreados
                });
            } catch (error) {
                addResult('ARQUEO - Sin diferencias', false, null, error.message);
            }
            setCurrentTest('');
        }

        async function testArqueoConDiferencias() {
            if (!checkAuth()) return;
            setCurrentTest('Realizando arqueo con diferencias...');
            try {
                const response = await apiRequest('/cajas/arqueo', {
                    method: 'POST',
                    body: JSON.stringify({
                        conteos: {
                            efectivo_bs: 66000,
                            efectivo_usd: 100,
                            pago_movil: 25000
                        },
                        diferencias: {
                            bs: 1000,
                            usd: 0,
                            pagoMovil: 0
                        },
                        observaciones: 'TEST: Arqueo con diferencias desde HTML',
                        adminAutorizado: {
                            nombre: 'Administrador Test HTML',
                            rol: 'admin'
                        }
                    })
                });
                
                addResult('ARQUEO - Con diferencias', true, {
                    arqueos: response.data.arqueos.length,
                    ajustesCreados: response.data.ajustesCreados,
                    diferencias: response.data.diferencias
                });
            } catch (error) {
                addResult('ARQUEO - Con diferencias', false, null, error.message);
            }
            setCurrentTest('');
        }

        async function testEvidenciaFotografica() {
                if (!checkAuth()) return;
                setCurrentTest('Subiendo evidencia fotogr√°fica...');
                try {
                    const imagenTest = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==';
                    
                    const response = await apiRequest('/cajas/evidencia-fotografica', {
                        method: 'POST',
                        body: JSON.stringify({
                            caja_id: cajaId,
                            evento: 'apertura',  // ‚úÖ CAMBIADO A VALOR V√ÅLIDO
                            imagen_base64: imagenTest,
                            usuario_id: null,
                            diferencias: null,
                            ceo_autorizado: false,
                            observaciones: 'TEST: Evidencia desde HTML'
                        })
                    });
                    
                    addResult('EVIDENCIA - Subir fotogr√°fica', true, {
                        evento: response.data.evento,
                        ruta: response.data.ruta_imagen
                    });
                } catch (error) {
                    addResult('EVIDENCIA - Subir fotogr√°fica', false, null, error.message);
                }
                setCurrentTest('');
            }

        async function testEliminarTransaccion() {
            if (!transaccionId) {
                showToast('No hay transacci√≥n para eliminar', 'error');
                return;
            }
            
            if (!checkAuth()) return;
            setCurrentTest('Eliminando transacci√≥n...');
            try {
                const response = await apiRequest(`/cajas/transacciones/${transaccionId}`, {
                    method: 'DELETE',
                    body: JSON.stringify({
                        motivo: 'TEST: Eliminaci√≥n desde HTML'
                    })
                });
                
                addResult('TRANSACCI√ìN - Eliminar', true, {
                    id: response.data.transaccion_eliminada.id,
                    motivo: response.data.motivo
                });
                transaccionId = null;
            } catch (error) {
                addResult('TRANSACCI√ìN - Eliminar', false, null, error.message);
            }
            setCurrentTest('');
        }

        async function testCerrarCaja() {
            if (!checkAuth()) return;
            setCurrentTest('Cerrando caja...');
            try {
                const response = await apiRequest('/cajas/cerrar', {
                    method: 'PUT',
                    body: JSON.stringify({
                        montoFinalBs: 51000,
                        montoFinalUsd: 100,
                        montoFinalPagoMovil: 25000,
                        observacionesCierre: 'TEST: Cierre desde HTML'
                    })
                });
                
                addResult('CAJA - Cerrar', true, {
                    id: response.data.id,
                    estado: response.data.estado,
                    horaCierre: response.data.horaCierre
                });
                cajaId = null;
            } catch (error) {
                addResult('CAJA - Cerrar', false, null, error.message);
            }
            setCurrentTest('');
        }

        async function testObtenerHistorial() {
            if (!checkAuth()) return;
            setCurrentTest('Obteniendo historial...');
            try {
                const response = await apiRequest('/cajas/historial?page=1&limit=5');
                addResult('CAJA - Obtener historial', true, {
                    total: response.data.cajas.length,
                    pagination: response.data.pagination
                });
            } catch (error) {
                addResult('CAJA - Obtener historial', false, null, error.message);
            }
            setCurrentTest('');
        }

        // Ejecutar todos los tests
        async function ejecutarTodosLosTests() {
            if (isRunning) return;
            if (!checkAuth()) return;
            
            isRunning = true;
            const btn = document.getElementById('btnEjecutarTodos');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Ejecutando Tests...';
            
            limpiarResultados();
            
            const tests = [
                testAuth,
                testObtenerCaja,
                testAbrirCaja,
                testCrearTransaccion,
                testObtenerTransacciones,
                testAutorizacionCEO,
                testArqueoSinDiferencias,
                testArqueoConDiferencias,
                testEvidenciaFotografica,
                testEliminarTransaccion,
                testCerrarCaja,
                testObtenerHistorial
            ];

            for (let i = 0; i < tests.length; i++) {
                try {
                    await tests[i]();
                    await new Promise(resolve => setTimeout(resolve, 1000));
                } catch (error) {
                    console.error(`Error en test ${i + 1}:`, error);
                }
            }
            
            isRunning = false;
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-play mr-2"></i>Ejecutar Todos los Tests';
            setCurrentTest('');
            showToast('üéâ Todos los tests completados', 'success');
        }

        // Limpiar resultados
        function limpiarResultados() {
            results = [];
            updateResultsUI();
            showToast('üßπ Resultados limpiados', 'success');
        }

        // Inicializar
        // Inicializar
document.addEventListener('DOMContentLoaded', function() {
    console.log('üîß DOM cargado, inicializando...');
    
    // Verificar elementos cr√≠ticos
    const requiredElements = [
        'resultsContainer',
        'resultsCount', 
        'noResults',
        'currentTest',
        'currentTestText'
    ];
    
    const missingElements = requiredElements.filter(id => !document.getElementById(id));
    
    if (missingElements.length > 0) {
        console.error('‚ùå Elementos faltantes:', missingElements);
        showToast('Error: Elementos del DOM faltantes', 'error');
        return;
    }
    
    console.log('‚úÖ Todos los elementos encontrados');
    updateResultsUI();
    
    if (!authToken) {
        showToast('üí° Tip: Necesitar√°s un token de autenticaci√≥n para ejecutar los tests', 'info');
    }
});
    </script>
</body>
</html>